---
import "../styles/global.css";

import Head from "../components/Head.astro";
import Header from "../components/Header.astro";

export async function getStaticPaths() {
  let QUERY, URL;

  //FETCH PAGE, CAT CONTENT
  QUERY = encodeURIComponent(
    `*[_type == "page"]{
    "seo": {title,description,slug,robots,canonical,schema,"ogimage": ogimage.asset->url},
    content[]{
      _type == "block" => {...},
    }
  }`
  );
  // Compose the URL for your project's endpoint and add the query
  URL = `https://${
    import.meta.env.PROJECT_ID
  }.api.sanity.io/v2021-10-21/data/query/${
    import.meta.env.DATASET
  }?query=${QUERY}`;
  // fetch the content
  let data = await fetch(URL)
    .then((res) => res.json())
    .then(({ result }) => {
      return result;
    })
    .catch((err) => console.error(err));

  let pages = data.map((page) => {
    return {
      slug: page.seo.slug,
      seo: page.seo,
      content: page.content,
    };
  });
  return pages.map(({ slug, seo, content }) => {
    if (slug == null) {
      slug = undefined;
    }
    return {
      params: { slug },
      props: { seo, content },
    };
  });
}

const { slug } = Astro.params;
console.log(slug);
const { seo, content } = Astro.props;
---

<!doctype html>
<html lang="fr" prefix="og: http://ogp.me/ns#">
  <Head seo={seo} />
  <body>
    <Header />
    <!-- <Render data="{content}" context="{context}" />
    <Footer /> -->
  </body>
</html>
